# E2E Test workflow - runs on a test repository
#
# This workflow tests the complete terraform-branch-deploy flow:
# 1. User comments ".plan to dev"
# 2. Action parses command
# 3. Config is loaded
# 4. Terraform is executed (with dry run for testing)
#
# Usage: Add this workflow to a test repository with terraform configs

name: E2E Test

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  deployments: write
  contents: write
  checks: read
  statuses: read

jobs:
  test:
    if: github.event.issue.pull_request
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: terraform-branch-deploy
        id: deploy
        # For testing, use the local action
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          # Use skip mode for E2E testing without real terraform
          mode: skip

      - name: Verify outputs
        if: steps.deploy.outputs.continue == 'true'
        run: |
          echo "✅ E2E Test Passed"
          echo "Environment: ${{ steps.deploy.outputs.environment }}"
          echo "SHA: ${{ steps.deploy.outputs.sha }}"
          echo "Noop: ${{ steps.deploy.outputs.noop }}"
          echo "Working Dir: ${{ steps.deploy.outputs.working-directory }}"
          echo "Var Files: ${{ steps.deploy.outputs.var-files }}"

      - name: Validate JSON outputs
        if: steps.deploy.outputs.continue == 'true'
        run: |
          # Verify var-files is valid JSON array
          echo '${{ steps.deploy.outputs.var-files }}' | jq -e .
          echo "✅ var-files is valid JSON"

          # Verify backend-configs is valid JSON array
          echo '${{ steps.deploy.outputs.backend-configs }}' | jq -e .
          echo "✅ backend-configs is valid JSON"
