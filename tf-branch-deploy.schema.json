{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "terraform-branch-deploy configuration schema",
  "description": "Schema for .tf-branch-deploy.yml used by the terraform-branch-deploy GitHub Action.",
  "type": "object",
  "properties": {
    "default-environment": {
      "type": "string",
      "description": "The name of the default environment to deploy to. If not set, defaults to 'production'. Example: by default, if you type .deploy, it will assume 'production' as the default environment."
    },
    "production-environments": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "A list of environments that should be treated as 'production'. By default, GitHub will set the 'production_environment' to 'true' if the environment name is 'production'. This option allows you to override that behavior so you can use 'prod', 'prd', 'main', 'production-eu', etc. as your production environment name."
    },
    "stable-branch": {
      "type": "string",
      "default": "main",
      "description": "The name of the stable branch to deploy from during rollbacks. Commands like '.apply main to dev' will deploy from this branch."
    },
    "hooks": {
      "type": "object",
      "description": "Lifecycle hooks for pre/post terraform execution phases.",
      "properties": {
        "pre-init": {
          "$ref": "#/$defs/hookArray",
          "description": "Hooks to run before terraform init. Use for security scanning, secrets detection."
        },
        "post-init": {
          "$ref": "#/$defs/hookArray",
          "description": "Hooks to run after terraform init. Use for provider validation."
        },
        "pre-plan": {
          "$ref": "#/$defs/hookArray",
          "description": "Hooks to run before terraform plan/apply. Use for linting, policy checks."
        },
        "post-plan": {
          "$ref": "#/$defs/hookArray",
          "description": "Hooks to run after terraform plan (plan operations only). Use for cost estimation."
        },
        "post-apply": {
          "$ref": "#/$defs/hookArray",
          "description": "Hooks to run after terraform apply (apply operations only). Use for CMDB updates, doc generation."
        }
      },
      "additionalProperties": false
    },
    "defaults": {
      "type": "object",
      "description": "Default values for all environments.",
      "properties": {
        "var-files": {
          "$ref": "#/$defs/pathsConfig"
        },
        "backend-configs": {
          "$ref": "#/$defs/pathsConfig"
        },
        "plan-args": {
          "$ref": "#/$defs/argsConfig"
        },
        "apply-args": {
          "$ref": "#/$defs/argsConfig"
        },
        "init-args": {
          "$ref": "#/$defs/argsConfig"
        }
      },
      "additionalProperties": false
    },
    "environments": {
      "type": "object",
      "description": "Environment-specific configuration.",
      "patternProperties": {
        "^[a-zA-Z0-9_-]+$": {
          "$ref": "#/$defs/environment"
        }
      },
      "additionalProperties": false
    }
  },
  "required": [
    "environments",
    "default-environment",
    "production-environments"
  ],
  "additionalProperties": false,
  "$defs": {
    "hook": {
      "type": "object",
      "description": "A single lifecycle hook.",
      "required": [
        "name",
        "run"
      ],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable name for the hook."
        },
        "run": {
          "type": "string",
          "description": "Shell command to execute."
        },
        "fail-on-error": {
          "type": "boolean",
          "default": true,
          "description": "If true, a non-zero exit code will fail the deployment. If false, a warning is logged but execution continues."
        },
        "timeout": {
          "type": "integer",
          "default": 600,
          "description": "Maximum seconds the hook can run before being killed."
        },
        "condition": {
          "type": "string",
          "enum": [
            "always",
            "plan-only",
            "apply-only",
            "rollback-only"
          ],
          "default": "always",
          "description": "When to run this hook. 'always' runs on all operations. 'plan-only' only on plan. 'apply-only' on apply and rollback. 'rollback-only' only when TF_BD_IS_ROLLBACK=true."
        },
        "working-directory": {
          "type": "string",
          "description": "Override the working directory for this hook."
        },
        "env": {
          "type": "object",
          "additionalProperties": {
            "type": "string"
          },
          "description": "Additional environment variables for this hook."
        }
      },
      "additionalProperties": false
    },
    "hookArray": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/hook"
      }
    },
    "pathsConfig": {
      "type": "object",
      "description": "Configuration for file paths (var-files, backend-configs).",
      "properties": {
        "inherit": {
          "type": "boolean",
          "default": true,
          "description": "Whether to inherit paths from defaults."
        },
        "paths": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of file paths."
        }
      },
      "additionalProperties": false
    },
    "argsConfig": {
      "type": "object",
      "description": "Configuration for command-line arguments (plan-args, apply-args, init-args).",
      "properties": {
        "inherit": {
          "type": "boolean",
          "default": true,
          "description": "Whether to inherit args from defaults."
        },
        "args": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of arguments."
        }
      },
      "additionalProperties": false
    },
    "environment": {
      "type": "object",
      "description": "Configuration for a single deployment environment.",
      "properties": {
        "working-directory": {
          "type": "string",
          "description": "Path to the Terraform code for this environment, relative to repo root."
        },
        "backend-configs": {
          "$ref": "#/$defs/pathsConfig"
        },
        "var-files": {
          "$ref": "#/$defs/pathsConfig"
        },
        "plan-args": {
          "$ref": "#/$defs/argsConfig"
        },
        "apply-args": {
          "$ref": "#/$defs/argsConfig"
        },
        "init-args": {
          "$ref": "#/$defs/argsConfig"
        }
      },
      "additionalProperties": false
    }
  }
}